<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Object Selection Optimizer</title>
  <style>
    :root {
      --gap: 10px;
      --card-radius: 8px;
      --colors: #FFCDD2, #F8BBD0, #E1BEE7, #D1C4E9, #C5CAE9, #BBDEFB, #B3E5FC, #B2EBF2, #B2DFDB, #C8E6C9, #DCEDC8, #F0F4C3;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 2rem;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: var(--gap);
      margin-bottom: 20px;
    }
    input,
    button {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      background: #4caf50;
      color: #fff;
      border: none;
    }
    button:hover {
      background: #45a049;
    }
    .batch-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--gap);
      margin-bottom: 30px;
    }
    .card {
      background: #fff;
      border-radius: var(--card-radius);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 15px;
      text-align: center;
      position: relative;
    }
    .card > .date {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 0.8rem;
      color: #666;
    }
    .card .room-ws {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .card .object {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    .counts {
      margin-top: 30px;
    }
    .counts ul {
      list-style: none;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--gap);
    }
    .counts li {
      background: #fff;
      padding: 8px;
      border-radius: var(--card-radius);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }
    #matrix {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    #matrix th,
    #matrix td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
    }
    #matrix th {
      background: #eee;
      font-size: 0.9rem;
    }
    .done {
      background: #c8e6c9;
    }
  </style>
</head>
<body>
  <h1>Object Selection Optimizer</h1>
  <div class="controls">
    <label>Date:<input type="date" id="date"></label>
    <label>#People:<input type="number" id="peopleCount" min="1" max="12" value="12"></label>
    <button id="assignBtn">Assign</button>
    <button id="resetBtn">Reset</button>
  </div>

  <section id="assignments" class="batch-list"></section>

  <section class="counts">
    <h2>Total Usage Counts</h2>
    <ul id="usageList"></ul>
  </section>

  <h2>Slot Usage Matrix</h2>
  <table id="matrix"></table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase config with databaseURL added
    const firebaseConfig = {
      apiKey: "AIzaSyDl2EkZ979ZB_xabqXoFFm1Kw_QQfniAkc",
      authDomain: "triton-ego4d-matrix.firebaseapp.com",
      databaseURL: "https://triton-ego4d-matrix.firebaseio.com",
      projectId: "triton-ego4d-matrix",
      storageBucket: "triton-ego4d-matrix.firebasestorage.app",
      messagingSenderId: "587475554830",
      appId: "1:587475554830:web:77c69aa312aea86c48e25f",
      measurementId: "G-ZXP60K67KD"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getDatabase(app);

    const OBJECTS = 12, ROOMS = 6, WS = 2, SLOTS = ROOMS * WS;
    let globalUsage = Array(OBJECTS).fill(0);
    let slotUsage = Array(SLOTS).fill().map(() => Array(OBJECTS).fill(0));

    const stateRef = ref(db, 'state');

    onValue(stateRef, snap => {
      if (snap.exists()) {
        const val = snap.val();
        globalUsage = val.globalUsage;
        slotUsage = val.slotUsage;
        console.log('Loaded state:', val);
      } else {
        set(stateRef, { globalUsage, slotUsage });
        console.log('Initialized state to default');
      }
      renderUsage();
      renderMatrix();
    }, error => {
      console.error('Firebase onValue error:', error);
    });

    function saveState() {
      set(stateRef, { globalUsage, slotUsage })
        .then(() => console.log('State saved'))
        .catch(err => console.error('Save error:', err));
    }

    function renderUsage() {
      const ul = document.getElementById('usageList'); ul.innerHTML = '';
      globalUsage.forEach((count, i) => {
        const li = document.createElement('li');
        li.textContent = `Obj ${i+1}: ${count}`;
        ul.appendChild(li);
      });
    }

    function renderMatrix() {
      const table = document.getElementById('matrix'); table.innerHTML = '';
      const header = ['Obj/Slot'];
      for (let i = 0; i < SLOTS; i++) header.push(`R${Math.floor(i/WS)+1}WS${(i%WS)+1}`);
      const trHead = document.createElement('tr'); header.forEach(text => { const th = document.createElement('th'); th.textContent = text; trHead.appendChild(th); }); table.appendChild(trHead);
      for (let o = 1; o <= OBJECTS; o++) {
        const tr = document.createElement('tr'); const th = document.createElement('th'); th.textContent = `Obj ${o}`; tr.appendChild(th);
        for (let s = 0; s < SLOTS; s++) {
          const td = document.createElement('td'); const c = slotUsage[s][o-1] || '';
          td.textContent = c; if (c) td.classList.add('done'); tr.appendChild(td);
        }
        table.appendChild(tr);
      }
    }

    function renderAssignments(batch, date) {
      const cont = document.getElementById('assignments'); cont.innerHTML = '';
      batch.forEach((obj, idx) => {
        const room = Math.floor(idx/WS) + 1;
        const ws = (idx % WS) + 1;
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `<div class="date">${date||''}</div><div class="room-ws">Room ${room}â€“WS ${ws}</div><div class="object">Obj ${obj}</div>`;
        const colors = getComputedStyle(document.documentElement).getPropertyValue('--colors').split(',');
        card.style.background = colors[obj-1].trim(); cont.appendChild(card);
      });
    }

    function pickForSlot(i, avail) {
      const minSlot = Math.min(...avail.map(id => slotUsage[i][id-1]));
      let cand = avail.filter(id => slotUsage[i][id-1] === minSlot);
      const minGlob = Math.min(...cand.map(id => globalUsage[id-1]));
      return cand.find(id => globalUsage[id-1] === minGlob);
    }

    async function assign() {
      const dateVal = document.getElementById('date').value;
      const count = parseInt(document.getElementById('peopleCount').value) || 0;
      let avail = Array.from({length: OBJECTS}, (_, i) => i+1);
      const batch = [];
      for (let i=0; i<Math.min(count, SLOTS); i++) {
        const p = pickForSlot(i, avail);
        batch.push(p); avail = avail.filter(id => id !== p);
        globalUsage[p-1]++; slotUsage[i][p-1]++;
      }
      saveState(); renderAssignments(batch, dateVal);
    }

    document.getElementById('assignBtn').addEventListener('click', assign);
    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm('Clear all history?')) return;
      globalUsage = Array(OBJECTS).fill(0);
      slotUsage = Array(SLOTS).fill().map(() => Array(OBJECTS).fill(0));
      saveState();
    });
  </script>
</body>
</html>
