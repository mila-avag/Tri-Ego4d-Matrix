<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Status Dashboard</title>
  <style>
    /* Remove tap highlight and focus outline */
    * { -webkit-tap-highlight-color: transparent; }
    button:focus { outline: none; }

    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1, h2 { margin-top: 0; }

    #errorMessage { display: none; background: #ffe6e6; color: #a33; padding: 1rem; border: 1px solid #a33; border-radius: 4px; margin-bottom: 1rem; }

    .login-group { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 2rem; }
    .login-group select,
    .login-group input,
    .login-group button { padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }

    .status-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; margin: 1rem 0; }
    .status-btn {
      flex: 1 1 calc(50% - 0.5rem);
      padding: 1rem;
      border: 2px solid transparent;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
      background: transparent;
      transition: opacity 0.2s;
    }
    .status-btn:hover { opacity: 0.8; }
    .status-btn[data-status="Tech issues"] { border-color: #e74c3c; color: #e74c3c; }
    .status-btn[data-status="Recording"] { border-color: #27ae60; color: #27ae60; }
    .status-btn[data-status="Setting up room"] { border-color: #f39c12; color: #f39c12; }
    .status-btn[data-status="Break"] { border-color: #3498db; color: #3498db; }
    .status-btn.active { color: #fff !important; }
    .status-btn.active[data-status="Tech issues"] { background: #e74c3c; }
    .status-btn.active[data-status="Recording"] { background: #27ae60; }
    .status-btn.active[data-status="Setting up room"] { background: #f39c12; }
    .status-btn.active[data-status="Break"] { background: #3498db; }

    #activeStatus { font-size: 1.2rem; margin-top: 1rem; }

    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.75rem; border: 1px solid #ddd; text-align: left; }
    th { background: #f7f7f7; }
    .log-row:nth-child(even) { background: #fafafa; }

    @media (max-width: 600px) {
      .login-group, .status-buttons { flex-direction: column; }
      /* Card-style rows */
      .log-row { display: block; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 1rem; padding: 0.75rem; background: #fff; }
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      td { border: none; border-bottom: 1px solid #ddd; padding: 0.5rem 1rem; position: relative; }
      td:last-child { border-bottom: none; }
      td:before { content: attr(data-label); font-weight: bold; display: inline-block; width: 6rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="errorMessage"></div>
    <div id="userSelection">
      <h1>Who are you?</h1>
      <div class="login-group">
        <select id="userSelect"><option value="" disabled selected>— select your name —</option></select>
        <input id="pinInput" type="password" placeholder="PIN or admin code">
        <button id="confirmUser">Login</button>
        <button id="createUser">Create Account</button>
      </div>
    </div>
    <div id="dashboardContainer" style="display:none">
      <h1>Status Dashboard</h1>
      <p id="userInfo"></p>
      <div id="activeStatus">Active status: <span id="statusText"></span></div>
      <div id="statusButtons" class="status-buttons"></div>
      <h2>Your Change Log</h2>
      <table id="log">
        <thead>
          <tr><th>Timestamp</th><th>Old</th><th>New</th><th>By</th><th>Hours</th></tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getDatabase, ref, get, push, set } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDl2EkZ979ZB_xabqXoFFm1Kw_QQfniAkc",
      authDomain: "triton-ego4d-matrix.firebaseapp.com",
      databaseURL: "https://triton-ego4d-matrix-default-rtdb.firebaseio.com",
      projectId: "triton-ego4d-matrix",
      storageBucket: "triton-ego4d-matrix.firebasestorage.app",
      messagingSenderId: "587475554830",
      appId: "1:587475554830:web:77c69aa312aea86c48e25f",
      measurementId: "G-ZXP60K67KD"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Refs
    const usersRef    = ref(db, 'users');
    const statusesRef = ref(db, 'statuses');
    const logsRef     = ref(db, 'logs');
    const configRef   = ref(db, 'config');

    let statusesArr = [], defaultStat = '', currentUser = '', isAdmin = false;

    const userSelect    = document.getElementById('userSelect');
    const pinInput      = document.getElementById('pinInput');
    const confirmBtn    = document.getElementById('confirmUser');
    const createBtn     = document.getElementById('createUser');
    const selDiv        = document.getElementById('userSelection');
    const dashDiv       = document.getElementById('dashboardContainer');
    const userInfo      = document.getElementById('userInfo');
    const statusText    = document.getElementById('statusText');
    const statusButtons = document.getElementById('statusButtons');
    const logBody       = document.getElementById('logBody');
    const errDiv        = document.getElementById('errorMessage');

    const showError = msg => { errDiv.textContent = msg; errDiv.style.display = 'block'; };
    const clearError = () => { errDiv.style.display = 'none'; };

    // Initialization
    function init() {
      get(configRef).then(snap => {
        if (!snap.exists()) {
          set(configRef, { statuses: ['Tech issues','Recording','Setting up room','Break'], defaultStatus: 'Tech issues' });
          statusesArr = ['Tech issues','Recording','Setting up room','Break']; defaultStat = 'Tech issues';
        } else {
          const cfg = snap.val(); statusesArr = cfg.statuses; defaultStat = cfg.defaultStatus;
        }
      }).catch(() => {
        showError('Config load failed');
        statusesArr = ['Tech issues','Recording','Setting up room','Break']; defaultStat = 'Tech issues';
      }).finally(loadUsers);
    }

    // Load users into dropdown
    function loadUsers() {
      clearError(); userSelect.innerHTML = '<option value="" disabled selected>— select your name —</option>';
      get(usersRef).then(snap => {
        if (snap.exists()) Object.keys(snap.val()).forEach(name => {
          const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
          userSelect.appendChild(opt);
        });
      }).catch(() => showError('Users load failed'));
    }

    // Create account
    createBtn.addEventListener('click', () => {
      clearError(); const name = prompt('Enter your name:'); if (!name) return;
      const pin = prompt('Set a 4-digit PIN or admin code:');
      if (pin !== 'robotsrcool' && !/^[0-9]{4}$/.test(pin)) return showError('PIN must be 4 digits or admin code');
      set(ref(db, `users/${name}`), { pin })
        .then(() => set(ref(db, `statuses/${name}`), { currentStatus: defaultStat, updatedAt: new Date().toISOString() }))
        .then(loadUsers)
        .catch(() => showError('Account creation failed'));
    });

    // Login
    confirmBtn.addEventListener('click', () => {
      clearError(); const name = userSelect.value, pin = pinInput.value;
      isAdmin = (pin === 'robotsrcool');
      if (!isAdmin) {
        get(ref(db, `users/${name}`)).then(snap => {
          if (!snap.exists() || snap.val().pin !== pin) throw new Error();
        }).catch(() => { showError('Invalid credentials'); return; });
      }
      if (!name || !pin) return showError('Select name and enter PIN');
      currentUser = name; selDiv.style.display = 'none'; dashDiv.style.display = 'block'; userInfo.textContent = `Logged in as: ${currentUser}`;
      loadStatus(); loadLogs();
    });

    // Load current status
    function loadStatus() {
      clearError();
      get(ref(db, `statuses/${currentUser}`)).then(snap => {
        const stat = snap.exists() ? snap.val().currentStatus : defaultStat;
        renderStatus(stat);
      }).catch(() => showError('Status fetch failed'));
    }

    // Load log entries
    function loadLogs() {
      clearError(); logBody.innerHTML = '';
      get(logsRef).then(snap => {
        if (snap.exists()) Object.values(snap.val()).forEach(d => {
          if (isAdmin || d.name === currentUser) appendLog(d);
        });
      }).catch(() => showError('Logs load failed'));
    }

    // Render status buttons
    function renderStatus(current) {
      statusText.textContent = current; statusButtons.innerHTML = '';
      statusesArr.forEach(s => {
        const btn = document.createElement('button'); btn.className = 'status-btn'; btn.dataset.status = s; btn.textContent = s;
        if (s === current) btn.classList.add('active');
        btn.addEventListener('click', () => updateStatus(s)); statusButtons.appendChild(btn);
      });
    }

    // Update status
    function updateStatus(newS) {
      clearError(); const oldS = statusText.textContent; const ts = new Date();
      get(logsRef).then(snap => {
        let prevTime = '';
        if (snap.exists()) {
          const arr = Object.values(snap.val()).filter(d => d.name === currentUser);
          if (arr.length) prevTime = ((ts - new Date(arr[arr.length-1].timestamp)) / 3600000).toFixed(2);
        }
        appendLog({ timestamp: ts.toISOString(), oldStatus: oldS, newStatus: newS, user: currentUser, timeSpent: prevTime, name: currentUser });
        return push(ref(db, 'logs'), { timestamp: ts.toISOString(), name: currentUser, oldStatus: oldS, newStatus: newS, user: currentUser, timeSpent: parseFloat(prevTime)||0 });
      }).then(() => set(ref(db, `statuses/${currentUser}`), { currentStatus: newS, updatedAt: new Date().toISOString() }))
        .then(() => renderStatus(newS)).catch(() => showError('Update failed'));
    }

    // Append one log row
    function appendLog(d) {
      const tr = document.createElement('tr'); tr.className = 'log-row';
      tr.innerHTML = `
        <td data-label="Timestamp">${new Date(d.timestamp).toLocaleString()}</td>
        <td data-label="Old">${d.oldStatus||''}</td>
        <td data-label="New">${d.newStatus||''}</td>
        <td data-label="By">${d.user||''}</td>
        <td data-label="Hours">${d.timeSpent!=null?d.timeSpent:''}</td>
      `;
      logBody.appendChild(tr);
    }

    init();
  </script>
</body>
</html>
